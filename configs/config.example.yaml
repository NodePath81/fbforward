hostname: fbforward-01

forwarding:
  # Where fbforward listens for client connections.
  listeners:
    - bind_addr: 0.0.0.0
      bind_port: 9000
      protocol: tcp
      # Optional per-listener shaping (requires shaping.enabled).
      shaping:
        upload_limit: 50m
        download_limit: 200m
    - bind_addr: 0.0.0.0
      bind_port: 9000
      protocol: udp

  # Flow management.
  limits:
    max_tcp_connections: 50
    max_udp_mappings: 500

  idle_timeout:
    tcp: 60s
    udp: 30s

upstreams:
  # Global upstream list shared by all listeners.
  - tag: primary
    destination:
      host: 203.0.113.10
    measurement:
      # Optional measurement host/port (defaults to destination.host/9876).
      host: 203.0.113.10
      port: 9876
    # Optional tuning.
    priority: 0
    bias: 0
    # Optional per-upstream shaping (requires shaping.enabled).
    # Limits bandwidth to/from this upstream's IP address.
    shaping:
      upload_limit: 100m     # fbforward sends to upstream
      download_limit: 500m   # fbforward receives from upstream
  - tag: backup
    destination:
      host: example.net
    # Shaping also works with hostname upstreams (resolved IPs are shaped).
    shaping:
      upload_limit: 50m
      download_limit: 200m

dns:
  # Optional custom DNS servers (ip or ip:port). Empty = system DNS.
  servers:
    - 1.1.1.1
  # Optional address selection strategy: ipv4_only or prefer_ipv6.
  # If omitted, both A and AAAA results are used.
  # strategy: ipv4_only

reachability:
  # ICMP reachability probe interval/window.
  probe_interval: 1s
  window_size: 5
  # Delay before starting ICMP probes.
  startup_delay: 5s

measurement:
  # Measurement startup delay and staleness behavior.
  startup_delay: 10s
  stale_threshold: 60m
  fallback_to_icmp_on_stale: true

  # Scheduling and capacity gating.
  schedule:
    interval:
      min: 15m
      max: 45m
    upstream_gap: 5s
    headroom:
      max_link_utilization: 0.7
      required_free_bandwidth: "0"

  # Fast start + warmup.
  fast_start:
    enabled: true
    timeout: 500ms
    warmup_duration: 15s

  # Protocol-specific test parameters.
  protocols:
    tcp:
      enabled: true
      alternate: true
      target_bandwidth:
        upload: 10m
        download: 50m
      chunk_size: 1200
      sample_size: 500kb
      sample_count: 1
      timeout:
        per_sample: 10s
        per_cycle: 30s
    udp:
      enabled: true
      target_bandwidth:
        upload: 10m
        download: 50m
      chunk_size: 1200
      sample_size: 500kb
      sample_count: 1
      timeout:
        per_sample: 10s
        per_cycle: 30s

scoring:
  # EMA smoothing and reference values.
  smoothing:
    alpha: 0.2

  reference:
    tcp:
      bandwidth:
        upload: 10m
        download: 50m
      latency:
        rtt: 50
        jitter: 10
      retransmit_rate: 0.01
    udp:
      bandwidth:
        upload: 10m
        download: 50m
      latency:
        rtt: 50
        jitter: 10
      loss_rate: 0.01

  weights:
    tcp:
      bandwidth_upload: 0.15
      bandwidth_download: 0.25
      rtt: 0.25
      jitter: 0.10
      retransmit_rate: 0.25
    udp:
      bandwidth_upload: 0.10
      bandwidth_download: 0.30
      rtt: 0.15
      jitter: 0.30
      loss_rate: 0.15
    protocol_blend:
      tcp_weight: 0.5
      udp_weight: 0.5

  utilization_penalty:
    enabled: true
    window_duration: 5s
    update_interval: 1s
    threshold: 0.7
    min_multiplier: 0.3
    exponent: 2

  bias_transform:
    kappa: 0.693

switching:
  # Auto mode switch confirmation and failover behavior.
  auto:
    confirm_duration: 15s
    score_delta_threshold: 5
    min_hold_time: 30s
  failover:
    loss_rate_threshold: 0.2
    retransmit_rate_threshold: 0.2
  close_flows_on_failover: false

control:
  # Control plane bind + auth token.
  bind_addr: 127.0.0.1
  bind_port: 8080
  auth_token: "change-me"
  webui:
    enabled: true
  metrics:
    enabled: true

shaping:
  # Linux tc shaping via netlink (requires CAP_NET_ADMIN).
  enabled: false
  # Network device to shape (required when enabled).
  interface: eth0
  # IFB device used for ingress shaping.
  ifb_device: ifb0
  # Aggregate cap for each direction (bits/sec, SI units).
  aggregate_limit: 1g
